# M3 åŒæ¨¡å‹æ¨ç†ç®¡çº¿ä½¿ç”¨æŒ‡å—

## ğŸš€ æ¦‚è¿°

M3ï¼ˆMulti-Model Orchestratorï¼‰æ˜¯ä¸€ä¸ªå…ˆè¿›çš„åŒæ¨¡å‹æ¨ç†ç®¡çº¿ï¼Œå®ç°äº†å®Œæ•´çš„PLANâ†’ACTâ†’JUDGEçŠ¶æ€æœºï¼Œæ”¯æŒå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡æ‰§è¡Œã€‚

## ğŸ—ï¸ æ¶æ„ç‰¹ç‚¹

- **åŒæ¨¡å‹åˆ†å·¥**ï¼š
  - **Planner (DeepSeek-R1)**: è´Ÿè´£æ¨ç†è§„åˆ’å’Œåˆ¶å®šæ‰§è¡Œè®¡åˆ’
  - **Executor (DeepSeek-V3/V3.1)**: è´Ÿè´£æ‰§è¡Œå·¥å…·è°ƒç”¨å’Œå…·ä½“æ“ä½œ
  - **Judge (DeepSeek-R1)**: è´Ÿè´£è¯„ä¼°æ‰§è¡Œç»“æœå’Œå†³å®šä¸‹ä¸€æ­¥

- **æ™ºèƒ½çŠ¶æ€æœº**ï¼š
  - PLAN: ç”Ÿæˆæ‰§è¡Œè®¡åˆ’
  - ACT: æ‰§è¡Œè®¡åˆ’æ­¥éª¤
  - JUDGE: è¯„ä¼°ç»“æœå¹¶å†³å®šæ˜¯å¦ç»§ç»­æˆ–å®Œæˆ

## ğŸ“‹ ä½¿ç”¨æ–¹æ³•

### 1. ä¼ ç»Ÿæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
```python
from agent_core import create_agent_core_with_llm

# ä½¿ç”¨ä¼ ç»ŸAgentæ¨¡å¼
agent = create_agent_core_with_llm(use_m3=False)
result = await agent.process("ç°åœ¨å‡ ç‚¹äº†ï¼Ÿ")
print(result['response'])
```

### 2. M3 ç¼–æ’å™¨æ¨¡å¼
```python
from agent_core import create_agent_core_with_llm

# å¯ç”¨M3ç¼–æ’å™¨æ¨¡å¼
agent = create_agent_core_with_llm(use_m3=True)
result = await agent.process("å¸®æˆ‘è®¡ç®—ä¸€ä¸‹å¤æ‚çš„æ•°å­¦é¢˜ï¼Œç„¶åæŸ¥è¯¢å¤©æ°”")

# æŸ¥çœ‹è¯¦ç»†çš„ç¼–æ’ä¿¡æ¯
print(f"ç¼–æ’çŠ¶æ€: {result['metadata']['mode']}")
print(f"è¿­ä»£æ¬¡æ•°: {result['metadata']['iteration_count']}")
print(f"å·¥å…·è°ƒç”¨è½¨è¿¹: {len(result['metadata']['tool_call_trace'])}")
```

### 3. ç¯å¢ƒå˜é‡æ§åˆ¶
```bash
# å¯ç”¨M3æ¨¡å¼
export USE_M3_ORCHESTRATOR=true

# ç„¶åå¯åŠ¨Gradio UI
python ui_gradio.py
```

### 4. ç›´æ¥ä½¿ç”¨ç¼–æ’å™¨
```python
from orchestrator import orchestrate_query

# ç›´æ¥ä½¿ç”¨ç¼–æ’å™¨
result = await orchestrate_query("åˆ†æè¿™ä»½æ–‡æ¡£å¹¶ç”Ÿæˆæ‘˜è¦")
print(f"æœ€ç»ˆç­”æ¡ˆ: {result.final_answer}")
print(f"æ‰§è¡Œæ­¥éª¤: {len(result.final_plan.steps)}")
```

## ğŸ”§ é…ç½®é€‰é¡¹

### ç¼–æ’å™¨å‚æ•°
```python
from orchestrator import Orchestrator

# è‡ªå®šä¹‰ç¼–æ’å™¨é…ç½®
orchestrator = Orchestrator(
    max_iterations=3,      # æœ€å¤§è¿­ä»£æ¬¡æ•°
    max_execution_time=60  # æœ€å¤§æ‰§è¡Œæ—¶é—´ï¼ˆç§’ï¼‰
)
```

### æ¨¡å‹é€‰æ‹©
- **Planner/Judge**: è‡ªåŠ¨ä½¿ç”¨ `deepseek-reasoner`ï¼ˆæ¨ç†å¢å¼ºï¼‰
- **Executor**: è‡ªåŠ¨ä½¿ç”¨ `deepseek-chat`ï¼ˆå·¥å…·è°ƒç”¨ä¼˜åŒ–ï¼‰

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### âœ… å·²å®ç°åŠŸèƒ½
- [x] å®Œæ•´çš„PLANâ†’ACTâ†’JUDGEçŠ¶æ€æœº
- [x] è‡ªåŠ¨å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
- [x] æ™ºèƒ½è¿­ä»£å’Œé”™è¯¯é‡è¯•
- [x] JSONæ ¼å¼ä¸¥æ ¼éªŒè¯
- [x] è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—è®°å½•

### ğŸ”„ å·¥ä½œæµç¨‹ç¤ºä¾‹

```
ç”¨æˆ·æŸ¥è¯¢: "å¸®æˆ‘è®¡ç®—(12+3*4)^2ï¼Œç„¶åå‘Šè¯‰æˆ‘åŒ—äº¬çš„å¤©æ°”"

1. PLANé˜¶æ®µ (DeepSeek-R1)
   â”œâ”€â”€ åˆ†ææŸ¥è¯¢éœ€æ±‚
   â”œâ”€â”€ ç”Ÿæˆæ‰§è¡Œè®¡åˆ’:
   â”‚   â”œâ”€â”€ æ­¥éª¤1: è°ƒç”¨math_calcå·¥å…·è®¡ç®—æ•°å­¦é¢˜
   â”‚   â””â”€â”€ æ­¥éª¤2: è°ƒç”¨weather_getå·¥å…·æŸ¥è¯¢å¤©æ°”
   â””â”€â”€ è¾“å‡ºJSONæ ¼å¼çš„è®¡åˆ’

2. ACTé˜¶æ®µ (DeepSeek-V3)
   â”œâ”€â”€ æ‰§è¡Œæ­¥éª¤1: math_calc("(12+3*4)^2")
   â”œâ”€â”€ ä¿å­˜ç»“æœ: {"result": 225}
   â”œâ”€â”€ æ‰§è¡Œæ­¥éª¤2: weather_get({"location": "åŒ—äº¬"})
   â””â”€â”€ ä¿å­˜ç»“æœ: {"weather": "æ™´å¤©", "temperature": "25Â°C"}

3. JUDGEé˜¶æ®µ (DeepSeek-R1)
   â”œâ”€â”€ è¯„ä¼°æ‰§è¡Œç»“æœ
   â”œâ”€â”€ åˆ¤æ–­æ˜¯å¦æ»¡è¶³ç”¨æˆ·éœ€æ±‚
   â””â”€â”€ è¾“å‡ºæ»¡æ„åº¦åˆ†æ

4. æœ€ç»ˆè¾“å‡º
   â”œâ”€â”€ æ•°å­¦è®¡ç®—ç»“æœ: 225
   â””â”€â”€ åŒ—äº¬å¤©æ°”: æ™´å¤©, 25Â°C
```

## ğŸ› ï¸ å¯ç”¨å·¥å…·

| å·¥å…·åç§° | åŠŸèƒ½æè¿° | å‚æ•°ç¤ºä¾‹ |
|---------|---------|---------|
| `time_now` | è·å–å½“å‰æ—¶é—´ | `{}` |
| `math_calc` | æ•°å­¦è®¡ç®— | `{"expression": "(12+3*4)^2"}` |
| `weather_get` | å¤©æ°”æŸ¥è¯¢ | `{"location": "åŒ—äº¬"}` |
| `calendar_read` | æ—¥ç¨‹æŸ¥çœ‹ | `{"start_date": "2025-01-01"}` |
| `email_list` | é‚®ä»¶æŸ¥çœ‹ | `{"limit": 10}` |
| `file_read` | æ–‡ä»¶è¯»å– | `{"file_path": "document.txt"}` |

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### çŠ¶æ€æŒ‡æ ‡
```python
result = await agent.process("æŸ¥è¯¢ä»»åŠ¡")

# æŸ¥çœ‹ç¼–æ’å™¨çŠ¶æ€
metadata = result['metadata']
print(f"æ¨¡å¼: {metadata['mode']}")
print(f"çŠ¶æ€: {metadata['status']}")
print(f"è¿­ä»£æ¬¡æ•°: {metadata['iteration_count']}")
print(f"æ€»æ—¶é—´: {metadata['total_time']:.2f}s")
print(f"å·¥å…·è°ƒç”¨: {len(metadata['tool_call_trace'])}")
```

### æ—¥å¿—è®°å½•
æ‰€æœ‰ç¼–æ’è¿‡ç¨‹éƒ½ä¼šè®°å½•è¯¦ç»†æ—¥å¿—ï¼š
- `/logs/agent.log` - ä¸»è¦æ—¥å¿—
- æ§åˆ¶å°è¾“å‡º - å®æ—¶çŠ¶æ€

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **èµ„æºæ¶ˆè€—**: M3æ¨¡å¼ä¼šæ¶ˆè€—æ›´å¤šAPIè°ƒç”¨ï¼Œå¯èƒ½äº§ç”Ÿæ›´é«˜è´¹ç”¨
2. **å“åº”æ—¶é—´**: å¤æ‚ä»»åŠ¡å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´å®Œæˆ
3. **é”™è¯¯å¤„ç†**: ç³»ç»Ÿä¼šè‡ªåŠ¨é‡è¯•å¤±è´¥çš„æ“ä½œï¼Œä½†å¯èƒ½éœ€è¦æ‰‹åŠ¨å¹²é¢„
4. **æ•°æ®éªŒè¯**: æ‰€æœ‰è¾“å…¥è¾“å‡ºéƒ½ä¼šè¿›è¡Œä¸¥æ ¼éªŒè¯

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜
1. **"LLMè°ƒç”¨å¤±è´¥"** - æ£€æŸ¥APIå¯†é’¥å’Œç½‘ç»œè¿æ¥
2. **"å·¥å…·ä¸å­˜åœ¨"** - ç¡®è®¤å·¥å…·åç§°æ‹¼å†™æ­£ç¡®
3. **"è¿­ä»£æ¬¡æ•°è¶…é™"** - ä»»åŠ¡å¯èƒ½è¿‡äºå¤æ‚ï¼Œå°è¯•ç®€åŒ–
4. **"æ‰§è¡Œè¶…æ—¶"** - å¢åŠ max_execution_timeå‚æ•°

### è°ƒè¯•æ¨¡å¼
```python
import logging
logging.getLogger().setLevel(logging.DEBUG)
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **é€‰æ‹©åˆé€‚çš„æ¨¡å¼**:
   - ç®€å•æŸ¥è¯¢ç”¨ä¼ ç»Ÿæ¨¡å¼
   - å¤æ‚å¤šæ­¥éª¤ä»»åŠ¡ç”¨M3æ¨¡å¼

2. **åˆç†è®¾ç½®å‚æ•°**:
   - æ ¹æ®ä»»åŠ¡å¤æ‚åº¦è°ƒæ•´max_iterations
   - é¢„ä¼°æ‰§è¡Œæ—¶é—´è®¾ç½®max_execution_time

3. **ç›‘æ§èµ„æºä½¿ç”¨**:
   - å®šæœŸæ£€æŸ¥APIè°ƒç”¨æ¬¡æ•°å’Œè´¹ç”¨
   - ç›‘æ§å“åº”æ—¶é—´å’ŒæˆåŠŸç‡

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

- **çŠ¶æ€æœºå®ç°**: åŸºäºå¼‚æ­¥åç¨‹çš„çŠ¶æ€è½¬æ¢
- **é”™è¯¯å¤„ç†**: å¤šå±‚å¼‚å¸¸æ•è·å’Œè‡ªåŠ¨é‡è¯•
- **æ•°æ®æµ**: ç»“æ„åŒ–çš„artifactç®¡ç†å’Œä¼ é€’
- **æ‰©å±•æ€§**: æ’ä»¶å¼çš„å·¥å…·å’Œæ¨¡å—è®¾è®¡

---

**å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚**
