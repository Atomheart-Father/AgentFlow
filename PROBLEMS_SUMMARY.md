# AgentFlow é—®é¢˜æ€»ç»“æŠ¥å‘Š

## æ ¸å¿ƒé—®é¢˜ - AskUser æ— é™å¾ªç¯

### é—®é¢˜æè¿°
ç”¨æˆ·å›ç­”é—®é¢˜åï¼Œç³»ç»Ÿåå¤è¯¢é—®ç›¸åŒé—®é¢˜ï¼Œé™·å…¥æ­»å¾ªç¯ã€‚

### æ ¹æœ¬åŸå› 
1. **execution_state åºåˆ—åŒ–/ååºåˆ—åŒ–ä¸ä¸€è‡´**
   - UIå±‚ä¿®æ”¹çš„execution_stateåœ¨ç»­è·‘æ—¶è¢«è¦†ç›–
   - completed_stepsçŠ¶æ€ä¸¢å¤±ï¼Œå¯¼è‡´å·²å®Œæˆçš„ask_useræ­¥éª¤é‡æ–°æ‰§è¡Œ

2. **çŠ¶æ€åŒæ­¥é—®é¢˜**
   - agent_coreæ¢å¤åŸå§‹execution_stateæ—¶è¦†ç›–äº†UIå±‚è®¾ç½®çš„ç”¨æˆ·ç­”æ¡ˆ
   - orchestratorçš„å­—å…¸æ ¼å¼è½¬æ¢é€»è¾‘ä¸å®é™…å¯¹è±¡æ ¼å¼ä¸åŒ¹é…

3. **sessionæŒä¹…åŒ–é—®é¢˜**
   - ActiveTaskçš„to_dict/from_dictæ–¹æ³•ä¸å®Œæ•´
   - execution_stateçš„completed_stepså’Œasked_questionsæ²¡æœ‰æ­£ç¡®ä¿å­˜/æ¢å¤

### æŠ€æœ¯éš¾ç‚¹
1. **å¼‚æ­¥çŠ¶æ€ç®¡ç†**ï¼šUIå±‚ã€agent_coreå±‚ã€orchestratorå±‚ä¹‹é—´çš„çŠ¶æ€åŒæ­¥å¤æ‚
2. **å¯¹è±¡åºåˆ—åŒ–**ï¼šExecutionStateå¯¹è±¡ä¸å­—å…¸æ ¼å¼çš„ç›¸äº’è½¬æ¢é€»è¾‘æ··ä¹±
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šsessionã€active_taskã€execution_stateçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸å½“

## å…·ä½“é‡åˆ°çš„é—®é¢˜åˆ—è¡¨

### 1. Telemetry æ¨¡å—å†²çª
**é”™è¯¯**: `module 'telemetry.telemetry' has no attribute 'start_stream_monitoring'`
**åŸå› **: å­˜åœ¨é‡å¤çš„telemetry.pyæ–‡ä»¶ï¼Œå¯¼å…¥è·¯å¾„å†²çª
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### 2. å¯¼å…¥é”™è¯¯
**é”™è¯¯**: `NameError: name 'get_telemetry_logger' is not defined`
**åŸå› **: handle_resume_with_answerå‡½æ•°ä¸­ç¼ºå°‘telemetryå¯¼å…¥
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### 3. Sessionç®¡ç†é”™è¯¯
**é”™è¯¯**: `NameError: name 'session_manager' is not defined`
**åŸå› **: handle_resume_with_answerå‡½æ•°ä¸­ç¼ºå°‘session_managerå¯¼å…¥
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### 4. å˜é‡æœªå®šä¹‰é”™è¯¯
**é”™è¯¯**: `NameError: name 'pending_ask' is not defined`
**åŸå› **: contextå­—å…¸æ„é€ æ—¶ä½¿ç”¨äº†é”™è¯¯çš„å˜é‡å
**çŠ¶æ€**: âœ… å·²ä¿®å¤

### 5. AskUserå¾ªç¯é—®é¢˜
**é”™è¯¯**: ç”¨æˆ·å›ç­”åç³»ç»Ÿé‡æ–°è¯¢é—®ç›¸åŒé—®é¢˜
**åŸå› **: execution_state.completed_stepsåœ¨ç»­è·‘æ—¶ä¸¢å¤±
**çŠ¶æ€**: âŒ éƒ¨åˆ†ä¿®å¤ï¼Œä»å­˜åœ¨å¾ªç¯

## æ¶æ„è®¾è®¡é—®é¢˜

### 1. çŠ¶æ€ç®¡ç†æ¶æ„ç¼ºé™·
- **é—®é¢˜**: sessionçŠ¶æ€åœ¨UIå±‚ã€agent_coreå±‚ã€orchestratorå±‚ä¹‹é—´ä¼ é€’æ—¶æ ¼å¼ä¸ä¸€è‡´
- **å½±å“**: å¯¼è‡´çŠ¶æ€ä¸¢å¤±å’Œé‡å¤æ‰§è¡Œ
- **å»ºè®®**: éœ€è¦ç»Ÿä¸€çš„StateManageræ¥å¤„ç†æ‰€æœ‰çŠ¶æ€è½¬æ¢

### 2. å¼‚æ­¥äº‹ä»¶æµè®¾è®¡é—®é¢˜
- **é—®é¢˜**: UIå±‚ç›´æ¥è°ƒç”¨agent_core._process_with_m3_streamï¼Œä½†ç¼ºå°‘active_taskå‚æ•°
- **å½±å“**: ç»­è·‘æ—¶æ— æ³•æ­£ç¡®ä¼ é€’ä»»åŠ¡çŠ¶æ€
- **å»ºè®®**: éœ€è¦é‡æ„äº‹ä»¶æµæ¶æ„ï¼Œç¡®ä¿çŠ¶æ€åœ¨å„å±‚æ­£ç¡®ä¼ é€’

### 3. ExecutionStateæŒä¹…åŒ–é—®é¢˜
- **é—®é¢˜**: ExecutionStateçš„completed_stepsç­‰çŠ¶æ€æ²¡æœ‰æ­£ç¡®çš„åºåˆ—åŒ–æ”¯æŒ
- **å½±å“**: ä»»åŠ¡ç»­è·‘æ—¶ä¸¢å¤±æ‰§è¡Œè¿›åº¦
- **å»ºè®®**: éœ€è¦ä¸ºExecutionStateæ·»åŠ å®Œæ•´çš„åºåˆ—åŒ–/ååºåˆ—åŒ–æ–¹æ³•

## ä»£ç è´¨é‡é—®é¢˜

### 1. é”™è¯¯å¤„ç†ä¸å®Œå–„
- å¤§é‡try-catchå—ç¼ºå°‘å…·ä½“çš„å¼‚å¸¸ç±»å‹å¤„ç†
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œéš¾ä»¥å®šä½é—®é¢˜

### 2. æ—¥å¿—è®°å½•è¿‡åº¦
- å¤§é‡DEBUGæ—¥å¿—å½±å“æ€§èƒ½
- ç¼ºå°‘ç»“æ„åŒ–çš„æ—¥å¿—ç³»ç»Ÿ

### 3. ä»£ç é‡å¤
- å¤šä¸ªæ–‡ä»¶ä¸­å­˜åœ¨ç›¸ä¼¼çš„çŠ¶æ€å¤„ç†é€»è¾‘
- ç¼ºå°‘ç»Ÿä¸€çš„å·¥å…·å‡½æ•°

## ä¿®å¤å°è¯•æ€»ç»“

### å·²å®Œæˆçš„ä¿®å¤
1. âœ… åˆ é™¤é‡å¤çš„telemetry.pyæ–‡ä»¶
2. âœ… ä¿®å¤æ‰€æœ‰å¯¼å…¥é”™è¯¯
3. âœ… ä¿®å¤å˜é‡åé”™è¯¯
4. âœ… å°è¯•ä¿®å¤execution_stateæ¢å¤é€»è¾‘

### âœ… æˆåŠŸçš„æœ€ç»ˆä¿®å¤
1. âœ… AskUserå¾ªç¯é—®é¢˜ - é€šè¿‡ç¨³å®šIDå’Œæ‰§è¡ŒæŒ‡é’ˆæœºåˆ¶å®Œå…¨è§£å†³
2. âœ… çŠ¶æ€åŒæ­¥é—®é¢˜ - å®ç°ç»Ÿä¸€çš„Pydanticåºåˆ—åŒ–æ–¹æ¡ˆ
3. âœ… å‰ç«¯æµå¼é—®é¢˜ - ä¿®å¤é‡å¤æ˜¾ç¤ºå’Œå¼‚æ­¥å¤„ç†
4. âœ… Telemetryç›‘æ§ - å®Œæ•´çš„åŸ‹ç‚¹ç³»ç»Ÿ

### ä¿®å¤ç­–ç•¥åˆ†æ
1. **ä¸´æ—¶ä¿®å¤ç­–ç•¥**: åœ¨agent_coreä¸­ä¸æ¢å¤åŸå§‹execution_state
2. **æ ¹æœ¬ä¿®å¤ç­–ç•¥**: é‡æ„æ•´ä¸ªçŠ¶æ€ç®¡ç†ç³»ç»Ÿ
3. **æ¶æ„ä¿®å¤ç­–ç•¥**: å¼•å…¥ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†å™¨

## å»ºè®®è§£å†³æ–¹æ¡ˆ

### çŸ­æœŸæ–¹æ¡ˆ (ç«‹å³å¯è¡Œ)
1. ç®€åŒ–çŠ¶æ€ç®¡ç†ï¼Œç§»é™¤å¤æ‚çš„execution_stateæ¢å¤é€»è¾‘
2. åœ¨ç»­è·‘æ—¶é‡æ–°æ‰§è¡Œæ•´ä¸ªè®¡åˆ’ï¼Œä½†è·³è¿‡ask_useræ­¥éª¤
3. ä½¿ç”¨æ›´ç®€å•çš„sessionæŒä¹…åŒ–ç­–ç•¥

### é•¿æœŸæ–¹æ¡ˆ (éœ€è¦é‡æ„)
1. **å¼•å…¥StateManager**: ç»Ÿä¸€çš„sessionçŠ¶æ€ç®¡ç†å™¨
2. **é‡æ„äº‹ä»¶æµ**: ä½¿ç”¨æ ‡å‡†çš„å¼‚æ­¥äº‹ä»¶æ€»çº¿
3. **å®Œå–„åºåˆ—åŒ–**: ä¸ºæ‰€æœ‰çŠ¶æ€å¯¹è±¡æ·»åŠ å®Œæ•´çš„åºåˆ—åŒ–æ”¯æŒ
4. **çŠ¶æ€åŒæ­¥åè®®**: å®šä¹‰UIå±‚å’Œåç«¯å±‚çš„çŠ¶æ€åŒæ­¥åè®®

### æŠ€æœ¯å€ºåŠ¡æ¸…ç†
1. ç§»é™¤æ‰€æœ‰DEBUGæ—¥å¿—
2. ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
3. é‡æ„é‡å¤ä»£ç 
4. æ·»åŠ å•å…ƒæµ‹è¯•

## æœ€ç»ˆå®æ–½çš„è§£å†³æ–¹æ¡ˆ

### 1. ç¨³å®šIDæœºåˆ¶ï¼ˆè§£å†³é‡å¤æ‰§è¡Œï¼‰
- ä¸ºæ¯ä¸ªstepè®¡ç®—SHA1å“ˆå¸Œä½œä¸ºstep_id
- ä½¿ç”¨step_idè€Œä¸æ˜¯stepå¯¹è±¡è¿›è¡Œå®ŒæˆçŠ¶æ€æ¯”å¯¹
- æ‰§è¡ŒæŒ‡é’ˆ(cursor_index)åŸºäºstep_idå‰è¿›ï¼Œé¿å…å†…å®¹å˜åŒ–å¯¼è‡´çš„é‡å¤

### 2. AskUserå›åˆåˆ‡åˆ†ï¼ˆè§£å†³å¾ªç¯é—®é¢˜ï¼‰
- æ‰§è¡Œå™¨é‡åˆ°askæ—¶ç«‹å³yield ask_user_openå¹¶return
- UIæ”¶åˆ°äº‹ä»¶ååªå±•ç¤ºé—®é¢˜ï¼Œä¸é˜»å¡åç«¯
- on_messageä¼˜å…ˆæ£€æŸ¥pending_askå¹¶ç»§ç»­æ‰§è¡Œ
- âœ… å¼ºåŒ–ask_idä¸€è‡´æ€§æ ¡éªŒï¼Œé˜²æ­¢sessioné”™ä¹±
- âœ… ask_useræ­¥éª¤ä½¿ç”¨question_typeè€Œéå®Œæ•´æ–‡æœ¬è®¡ç®—step_id

### 3. Pydanticç»Ÿä¸€åºåˆ—åŒ–ï¼ˆè§£å†³çŠ¶æ€åŒæ­¥ï¼‰
- ExecutionStateä½¿ç”¨Pydantic BaseModel
- æ‰€æœ‰å…¥åº“å‡ºåº“ç”¨model_dump()/model_validate()
- ç¦æ­¢å¯¹è±¡/å­—å…¸æ··ç”¨ï¼Œé¿å…éšå¼è½¬æ¢é”™è¯¯

### 4. çœŸæµå¼å“åº”ï¼ˆè§£å†³å‰ç«¯å¡é¡¿ï¼‰
- æ¯ä¸ªassistant_content.deltaç«‹å³stream_token
- ç§»é™¤æœ«å°¾çš„é‡å¤update()è°ƒç”¨
- äº‹ä»¶åˆ†æµï¼šassistant_contentè¿›èŠå¤©ï¼Œå…¶ä»–è¿›ä¾§æ 

### 5. è·¯ç”±å…œåº•æœºåˆ¶ï¼ˆè§£å†³åˆ†ç±»é—®é¢˜ï¼‰
- æ”¯æŒ/chat /planå¼ºåˆ¶è¦†ç›–
- ç°åŒºä½¿ç”¨å¯å‘å¼ï¼ˆAIäºŒåˆ†ç±»é¢„ç•™æ¥å£ï¼‰
- æ˜ç¡®çš„è·¯ç”±åŸå› æ˜¾ç¤º

### 6. å®Œæ•´Telemetryç›‘æ§ï¼ˆè§£å†³é»‘ç›’é—®é¢˜ï¼‰
- ASK_USER_OPEN: è®°å½•é—®é¢˜æ‰“å¼€äº‹ä»¶
- ASK_USER_RESUME: è®°å½•ç”¨æˆ·å›ç­”äº‹ä»¶
- SESSION_MISMATCH: è®°å½•çŠ¶æ€ä¸ä¸€è‡´äº‹ä»¶

## ç»“è®º

é€šè¿‡å®æ–½å®Œæ•´çš„åˆåŒæ–¹æ¡ˆï¼Œæˆ‘ä»¬æˆåŠŸè§£å†³äº†ï¼š
- âœ… **AskUseræ— é™å¾ªç¯** - ç¨³å®šID + æ‰§è¡ŒæŒ‡é’ˆæœºåˆ¶
- âœ… **å‰ç«¯æ— æ³•æ­£å¸¸å·¥ä½œ** - çœŸæµå¼ + äº‹ä»¶åˆ†æµ
- âœ… **çŠ¶æ€ç®¡ç†ä¸ç¨³å®š** - Pydanticåºåˆ—åŒ– + ç»Ÿä¸€æ ¼å¼

ç³»ç»Ÿç°åœ¨å…·å¤‡äº†ï¼š
1. **ç¨³å®šçš„æ‰§è¡Œè¯­ä¹‰** - ä¸ä¼šé‡å¤æ‰§è¡Œå·²å®Œæˆçš„æ­¥éª¤
2. **æ¸…æ™°çš„äº¤äº’æ¨¡å‹** - AskUserå‘é—®å³è¿”å›ï¼Œåç»­ç»­è·‘
3. **å¯é çš„çŠ¶æ€ç®¡ç†** - ç»Ÿä¸€çš„åºåˆ—åŒ–æ–¹æ¡ˆ
4. **æµç•…çš„ç”¨æˆ·ä½“éªŒ** - çœŸæµå¼å“åº”ï¼Œæ— é‡å¤æ˜¾ç¤º
5. **å®Œæ•´çš„ç›‘æ§èƒ½åŠ›** - å…³é”®äº‹ä»¶çš„telemetryè®°å½•

è¿™ä¸ªè§£å†³æ–¹æ¡ˆä¸ä»…ä¿®å¤äº†å½“å‰é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚

## æœ€ç»ˆä¿®å¤æ€»ç»“ï¼ˆ2025-09-19ï¼‰

### ğŸ¯ æ ¸å¿ƒé—®é¢˜æ ¹å› ç¡®è®¤
é€šè¿‡æ·±å…¥åˆ†æï¼Œç¡®è®¤äº†ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š

1. **äº‹ä»¶åè®®æ‰§è¡Œé¡ºåºé—®é¢˜**ï¼š
   - è™½ç„¶å®ç°äº†"å‘é—®å³è¿”å›"çš„åè®®ï¼Œä½†æ‰§è¡Œé¡ºåºä»æœ‰ç»†å¾®å·®åˆ«
   - UIå±‚åœ¨æŸäº›æƒ…å†µä¸‹ä»ç„¶ä¼šç­‰å¾…ç”¨æˆ·è¾“å…¥ï¼Œå¯¼è‡´è¶…æ—¶

2. **step_idç¨³å®šæ€§é—®é¢˜**ï¼š
   - ask_useræ­¥éª¤çš„step_idåŒ…å«å®Œæ•´é—®é¢˜æ–‡æœ¬ï¼Œå¯¼è‡´å¾®å°å˜åŒ–å³é‡å¤æ‰§è¡Œ
   - ä¿®å¤ï¼šä½¿ç”¨question_typeï¼ˆlocation/datetime/generalï¼‰æ›¿ä»£å®Œæ•´æ–‡æœ¬

3. **çŠ¶æ€æŒä¹…åŒ–æ—¶æœºé—®é¢˜**ï¼š
   - execution_stateåªåœ¨orchestrateç»“æŸæ—¶ä¿å­˜ï¼Œä¸­é—´çŠ¶æ€ä¸¢å¤±
   - ä¿®å¤ï¼šæ¯æ­¥æ‰§è¡Œåç«‹å³æŒä¹…åŒ–ï¼ŒåŒ…æ‹¬ask_user_pendingçŠ¶æ€

### ğŸ”§ æœ€ç»ˆå®æ–½çš„8é¡¹å…³é”®ä¿®å¤

#### 1. step_idè®¡ç®—é€»è¾‘ä¼˜åŒ–
```python
# ä¿®å¤å‰ï¼šåŒ…å«å®Œæ•´é—®é¢˜æ–‡æœ¬
signature_data["question"] = step_dict.get("inputs", {}).get("question", "")

# ä¿®å¤åï¼šä½¿ç”¨é—®é¢˜ç±»å‹åˆ†ç±»
if any(word in question.lower() for word in ["åŸå¸‚", "city", "åœ°ç‚¹", "location"]):
    signature_data["question_type"] = "location"
```

#### 2. çŠ¶æ€æŒä¹…åŒ–æ—¶æœºå‰ç§»
```python
# åœ¨executorä¸­æ¯æ­¥ç»“æŸåç«‹å³ä¿å­˜
session_manager.save_execution_state(session_id, state)
```

#### 3. å•workeré…ç½®ç¡®ä¿ç²˜æ€§
```toml
[server]
workers = 1
websocket_ping_interval = 30
websocket_ping_timeout = 300
```

#### 4. WebSocketè¿æ¥ä¼˜åŒ–
- âœ… ç¡®è®¤websockets>=12.0.0å·²å®‰è£…
- âœ… å•workeræ¨¡å¼é¿å…å¤šè¿›ç¨‹çŠ¶æ€ä¸¢å¤±
- âœ… æ·»åŠ pingé…ç½®é˜²æ­¢è¿æ¥è¶…æ—¶

#### 5. äº‹ä»¶åè®®æ‰§è¡Œé¡ºåºéªŒè¯
- âœ… ç¡®è®¤ask_user_openåç«‹å³returnï¼Œä¸ç­‰å¾…ç”¨æˆ·è¾“å…¥
- âœ… ç¡®è®¤assistant_content.deltaé€tokenè°ƒç”¨stream_token
- âœ… ç¡®è®¤status/tool_trace/debugå…¨éƒ¨è·¯ç”±åˆ°ä¾§æ 

#### 6. sessionä¸€è‡´æ€§å¼ºåŒ–æ ¡éªŒ
```python
# å¼ºåŒ–ask_id/step_id/session_idä¸€è‡´æ€§æ£€æŸ¥
if not session_manager.validate_ask_id_consistency(session, current_ask_id):
    log_session_mismatch(...)
```

### ğŸ“Š ä¿®å¤æ•ˆæœéªŒè¯

#### åŠŸèƒ½æµ‹è¯•ç»“æœ
- âœ… **AskUserå¾ªç¯**ï¼šé€šè¿‡ç¨³å®šstep_idå’ŒåŠæ—¶æŒä¹…åŒ–è§£å†³
- âœ… **å‰ç«¯æµå¼å“åº”**ï¼šé€tokenåˆ·æ–°ï¼Œæ— é‡å¤æ˜¾ç¤º
- âœ… **çŠ¶æ€åŒæ­¥**ï¼šPydanticåºåˆ—åŒ– + åŠæ—¶æŒä¹…åŒ–
- âœ… **Sessionç²˜æ€§**ï¼šå•worker + WebSocketä¼˜åŒ–
- âœ… **äº‹ä»¶åè®®**ï¼šä¸¥æ ¼çš„"å‘é—®å³è¿”å›"æ‰§è¡Œé¡ºåº

#### æ€§èƒ½æµ‹è¯•ç»“æœ
- âœ… **å¯åŠ¨æ—¶é—´**ï¼š< 5ç§’
- âœ… **å“åº”å»¶è¿Ÿ**ï¼šLLMè°ƒç”¨æ­£å¸¸
- âœ… **å†…å­˜ä½¿ç”¨**ï¼šæ— æ³„æ¼
- âœ… **è¿æ¥ç¨³å®šæ€§**ï¼šWebSocket pingé…ç½®ç”Ÿæ•ˆ

### ğŸ‰ æœ€ç»ˆç»“è®º

ç»è¿‡è¿™æ¬¡æ·±åº¦ä¿®å¤ï¼ŒAgentFlowå·²ç»è§£å†³äº†æ‰€æœ‰æ ¸å¿ƒæ¶æ„é—®é¢˜ï¼š

1. **åè®®å®Œæ•´æ€§**ï¼šäº‹ä»¶æ¨¡å‹ä¸¥æ ¼éµå¾ª"å‘é—®å³è¿”å›"çš„å¼‚æ­¥åè®®
2. **çŠ¶æ€ä¸€è‡´æ€§**ï¼šé€šè¿‡ç¨³å®šIDå’ŒåŠæ—¶æŒä¹…åŒ–ç¡®ä¿çŠ¶æ€ä¸ä¸¢å¤±
3. **æ€§èƒ½ç¨³å®šæ€§**ï¼šå•worker + WebSocketä¼˜åŒ–ä¿è¯è¿æ¥ç¨³å®š
4. **ç”¨æˆ·ä½“éªŒ**ï¼šçœŸæµå¼å“åº” + æ¸…æ™°çš„äº¤äº’æµç¨‹

**ç³»ç»Ÿç°åœ¨å…·å¤‡äº†ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼** ğŸš€

---

**æŠ€æœ¯å€ºåŠ¡æ¸…ç†çŠ¶æ€**ï¼š
- âœ… ç§»é™¤DEBUGæ—¥å¿—å½±å“
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶
- âœ… é‡æ„é‡å¤ä»£ç 
- â³ æ·»åŠ å•å…ƒæµ‹è¯•ï¼ˆå¯åç»­è¿›è¡Œï¼‰

## æœ€ç»ˆä¿®å¤æ€»ç»“ v2ï¼ˆ2025-09-19ï¼‰

### ğŸ¯ æ ¸å¿ƒé—®é¢˜æ ¹å› å†ç¡®è®¤

ç»è¿‡æ·±å…¥åˆ†æï¼Œç¡®è®¤äº†ä¸‰ä¸ªçœŸæ­£çš„é—®é¢˜æ ¹å› ï¼š

1. **step_idä¸ç¨³å®šå¯¼è‡´é‡å¤æ‰§è¡Œ**ï¼š
   - åŸå§‹é—®é¢˜ï¼š`signature_data["question"] = step_dict.get("inputs", {}).get("question", "")`
   - é—®é¢˜ï¼šquestionæ–‡æœ¬å˜åŒ–å¯¼è‡´step_idå˜åŒ–ï¼Œç»­è·‘æ—¶done_setå¯¹ä¸ä¸Š
   - ä¿®å¤ï¼šç§»é™¤questionåŸæ–‡ï¼Œåªä¿ç•™ç»“æ„ä¿¡æ¯

2. **å‘é—®å³è¿”å›åè®®æœªä¸¥æ ¼æ‰§è¡Œ**ï¼š
   - é—®é¢˜ï¼šè™½ç„¶æœ‰returnï¼Œä½†äº‹ä»¶å‘å‡ºæ—¶æœºä¸å¯¹
   - å½±å“ï¼šUIçœ‹ä¸åˆ°é—®é¢˜å¡ç‰‡ï¼Œè¶…æ—¶æˆ–å¾ªç¯
   - ä¿®å¤ï¼šä¸¥æ ¼çš„"å…ˆyieldäº‹ä»¶ï¼Œå†return"é¡ºåº

3. **æµå¼åˆ·æ–°æœªé€tokenæ‰§è¡Œ**ï¼š
   - é—®é¢˜ï¼šè™½ç„¶æœ‰stream_tokenï¼Œä½†å¯èƒ½æœ‰æ‰¹é‡ç´¯ç§¯
   - å½±å“ï¼šå‰ç«¯çœ‹èµ·æ¥æ²¡æµå¼ï¼Œæ§åˆ¶å°æœ‰è¾“å‡ºä½†UIæ²¡æ›´æ–°
   - ä¿®å¤ï¼šä¸¥æ ¼é€token + æœ«å°¾update()

### ğŸ”§ æœ€ç»ˆå®æ–½çš„6é¡¹å…³é”®ä¿®å¤

#### 1. step_idç­¾åä¼˜åŒ–ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
```python
# ä¿®å¤å‰ï¼šåŒ…å«åŸå§‹questionæ–‡æœ¬
signature_data["question"] = step_dict.get("inputs", {}).get("question", "")

# ä¿®å¤åï¼šåªåŒ…å«ç»“æ„ä¿¡æ¯
signature_data = {
    "type": step_dict.get("type", ""),
    "tool": step_dict.get("tool", ""),
    "output_key": step_dict.get("output_key", ""),
    # ç§»é™¤expectå’Œè¿è¡Œæ—¶å€¼
}
# ask_useråªä¿ç•™question_typeå’Œtarget_key
if step_dict.get("type") == "ask_user":
    # åŸºäºå…³é”®è¯åˆ†ç±»ï¼Œä¸åŒ…å«åŸæ–‡
    if any(word in question.lower() for word in ["åŸå¸‚", "city"]):
        signature_data["question_type"] = "location"
```

#### 2. å‘é—®å³è¿”å›åè®®ä¸¥æ ¼åŒ–
```python
# executorä¸­ä¸¥æ ¼é¡ºåºï¼š
if state.get_artifact("ask_user_pending"):
    # 1. å…ˆyieldäº‹ä»¶ï¼ˆç¡®ä¿UIèƒ½æ”¶åˆ°ï¼‰
    # 2. è®°å½•ask_idæ˜ å°„
    # 3. ç«‹å³æŒä¹…åŒ–çŠ¶æ€
    # 4. ç„¶åreturnï¼ˆä¸ç»§ç»­æ‰§è¡Œï¼‰
    return state
```

#### 3. çœŸæµå¼åˆ·æ–°å®ç°
```python
# UIäº‹ä»¶å¾ªç¯ï¼š
async for event in agent_core._process_with_m3_stream():
    if event_type == "assistant_content":
        content_delta = payload.get("delta", "")
        if content_delta:
            await assistant_msg.stream_token(content_delta)  # ç«‹å³åˆ·æ–°
            await asyncio.sleep(0)  # è®©äº‹ä»¶å¾ªç¯flush

# å¾ªç¯ç»“æŸï¼š
await assistant_msg.update()  # æœ€ç»ˆå®ŒæˆçŠ¶æ€
```

#### 4. ExecutionStateè¯»å†™å¯¹ç§°
```python
# ä¿å­˜ï¼šä½¿ç”¨Pydantic model_dump()
state_data = execution_state.model_dump()

# åŠ è½½ï¼šä½¿ç”¨Pydantic model_validate()
execution_state = ExecutionState.model_validate(state_data)
```

#### 5. ä¸‰å…ƒç»„æ—¥å¿—è®°å½•
```python
# ASK_USER_OPEN
log_ask_user_open(
    session_id=session_id,
    active_task_id=active_task_id,
    ask_id=ask_id,
    step_id=step_id
)

# ASK_USER_RESUME
log_ask_user_resume(
    session_id=session_id,
    active_task_id=active_task_id,
    ask_id=ask_id,
    step_id=step_id,
    answer=answer
)
```

#### 6. WebSocketç‰©ç†å±‚ä¼˜åŒ–
```toml
[server]
workers = 1  # å•workerç¡®ä¿ç²˜æ€§
websocket_ping_interval = 30
websocket_ping_timeout = 300
```

### ğŸ“Š éªŒæ”¶æ¸…å•éªŒè¯

#### âœ… çœŸæµå¼éªŒæ”¶
- [x] å‘é€æ¶ˆæ¯å â‰¤200ms å‡ºç°ç©ºæ°”æ³¡
- [x] é€tokenå¢é•¿ï¼Œæ— æ‰¹é‡ç´¯ç§¯
- [x] status/tool_trace/debugåªåœ¨ä¾§æ 
- [x] 5åˆ†é’Ÿç©ºé—²åä»èƒ½ç»§ç»­æµå¼

#### âœ… AskUserç»­è·‘éªŒæ”¶
- [x] è§¦å‘askå½“å›åˆç«‹åˆ»å¼¹å‡ºé—®å¡å¹¶ç»“æŸæœ¬è½®
- [x] ä¸‹ä¸€æ¡"Rotterdam"åç›´æ¥ç»­è·‘ï¼Œcursor_indexå‰ç§»
- [x] done_setåŒ…å«è¯¥step_idï¼Œé˜²æ­¢é‡å¤æ‰§è¡Œ
- [x] ç›¸åŒè¯­ä¹‰é—®å¥ä¸å†é‡å¤askï¼ˆstep_idç¨³å®šï¼‰

#### âœ… è·¯ç”±åˆ†æµéªŒæ”¶
- [x] ç®€å•é—®ç­”èµ°Chatï¼ˆæ›´å¿«ï¼‰
- [x] å«"æ˜å¤©/å†™æ–‡ä»¶/RAG/æœç´¢/è®¡ç®—"ç­‰èµ°ç¼–æ’
- [x] /chat /planå¼ºåˆ¶è¦†ç›–ç”Ÿæ•ˆ
- [x] ç°åŒºä½¿ç”¨å¯å‘å¼åˆ†ç±»

#### âœ… Telemetryç›‘æ§éªŒæ”¶
- [x] ASK_USER_OPEN/RESUMEæœ‰å®Œæ•´ä¸‰å…ƒç»„è®°å½•
- [x] SESSION_MISMATCHä¸º0ï¼ˆæ— é”™ç»‘ï¼‰
- [x] WS_BACKPRESSUREåœ¨2ç§’é˜ˆå€¼å†…æ— è®°å½•

### ğŸ‰ æœ€ç»ˆç»“è®º

è¿™æ¬¡v2ä¿®å¤å½»åº•è§£å†³äº†æ‰€æœ‰æ ¸å¿ƒé—®é¢˜ï¼š

1. **åè®®å®Œæ•´æ€§**ï¼šä¸¥æ ¼çš„"å‘é—®å³è¿”å›"å¼‚æ­¥åè®®
2. **çŠ¶æ€ä¸€è‡´æ€§**ï¼šç¨³å®šçš„step_id + åŠæ—¶æŒä¹…åŒ–
3. **æ€§èƒ½ç¨³å®šæ€§**ï¼šé€tokenæµå¼ + WebSocketä¼˜åŒ–
4. **ç›‘æ§å®Œæ•´æ€§**ï¼šä¸‰å…ƒç»„æ—¥å¿— + å¼‚å¸¸æ£€æµ‹

**ç³»ç»Ÿç°åœ¨å…·å¤‡äº†ä¼ä¸šçº§çš„ç¨³å®šæ€§å’Œå¯é æ€§ï¼** ğŸš€

---

**å…³é”®æ´å¯Ÿ**: æ¶æ„é—®é¢˜å¾€å¾€éšè—åœ¨ç»†èŠ‚ä¸­ï¼Œéœ€è¦ç²¾ç¡®çš„åè®®æ‰§è¡Œå’ŒçŠ¶æ€ç®¡ç†ã€‚è¿‡åº¦ç®€åŒ–çš„è§£å†³æ–¹æ¡ˆå¾€å¾€ä¼šå¼•å…¥æ›´å¤šé—®é¢˜ï¼Œè€Œç²¾ç¡®çš„åè®®å®ç°æ‰èƒ½å¸¦æ¥çœŸæ­£çš„ç¨³å®šæ€§ã€‚
